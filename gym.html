<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover">
    <title>TITAN OS | Omega Edition</title>
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/512/dumbbell.png">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --bg-body: #000000;
            --bg-card: #121212;
            --bg-input: #1c1c1e;
            --primary: #6366f1; /* Indigo */
            --gold: #fbbf24;
            --success: #10b981;
            --danger: #ef4444;
            --purple: #a855f7;
            --text-main: #ffffff;
            --text-muted: #a3a3a3;
            --border: rgba(255,255,255,0.08);
            --radius: 18px;
            --nav-height: 80px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        body {
            margin: 0; padding: 0; font-family: 'Inter', sans-serif;
            background-color: var(--bg-body); color: var(--text-main);
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* --- UI Core --- */
        .view {
            display: none; flex: 1; overflow-y: auto; overflow-x: hidden;
            padding: 20px; padding-bottom: 120px;
            animation: fadeIn 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h1, h2, h3 { margin: 0; font-weight: 700; letter-spacing: -0.5px; }
        .subtitle { color: var(--text-muted); font-size: 0.85rem; margin-top: 4px; }

        /* --- Cards --- */
        .card {
            background: var(--bg-card); border-radius: var(--radius); padding: 20px;
            margin-bottom: 16px; border: 1px solid var(--border);
            box-shadow: 0 4px 12px rgba(0,0,0,0.4); position: relative;
        }

        /* --- Coach Tips Box --- */
        .coach-box {
            background: linear-gradient(90deg, rgba(99,102,241,0.1) 0%, rgba(168,85,247,0.1) 100%);
            border-left: 3px solid var(--primary);
            padding: 12px 15px; border-radius: 10px; margin-bottom: 15px;
            font-size: 0.85rem; color: #e0e7ff; display: flex; gap: 10px; align-items: start;
        }

        /* --- Badges --- */
        .badge-suggestion {
            display: inline-flex; align-items: center; gap: 4px;
            background: rgba(251, 191, 36, 0.1); color: var(--gold);
            padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600;
            margin-top: 5px; border: 1px solid rgba(251, 191, 36, 0.2);
        }

        .badge-1rm {
            font-size: 0.65rem; color: var(--purple); background: rgba(168, 85, 247, 0.1);
            padding: 2px 6px; border-radius: 4px; position: absolute; top: -18px; left: 50%; transform: translateX(-50%);
            white-space: nowrap; opacity: 0; transition: opacity 0.2s; pointer-events: none;
        }
        .input-wrapper:focus-within .badge-1rm, .smart-input:not(:placeholder-shown) + .badge-1rm { opacity: 1; }

        /* --- Inputs --- */
        .input-row { display: grid; grid-template-columns: 24px 1.2fr 1fr 0.6fr 44px; gap: 8px; align-items: center; margin-bottom: 15px; position: relative; }
        
        .input-wrapper { position: relative; width: 100%; }
        .smart-input {
            width: 100%; background: var(--bg-input); border: 1px solid transparent;
            color: white; padding: 12px; border-radius: 10px; font-size: 1.1rem; 
            text-align: center; font-weight: 600; transition: border 0.2s;
        }
        .smart-input:focus { border-color: var(--primary); background: #252525; }
        .smart-input::placeholder { color: #444; }

        .rpe-input {
            width: 100%; background: var(--bg-input); border: none; color: var(--text-muted);
            font-size: 0.8rem; text-align: center; border-radius: 8px; padding: 14px 0;
        }

        .input-tool-icon {
            position: absolute; right: 5px; top: 50%; transform: translateY(-50%);
            font-size: 0.8rem; color: var(--text-muted); opacity: 0.5; padding: 5px; cursor: pointer;
        }

        .checkbox {
            width: 44px; height: 44px; border-radius: 12px; background: var(--bg-input);
            display: flex; justify-content: center; align-items: center; cursor: pointer;
            color: transparent; border: 1px solid var(--border); transition: all 0.2s;
        }
        .checkbox.checked { background: var(--success); border-color: var(--success); color: #000; }

        /* --- Achievements --- */
        .trophy-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .trophy-card {
            background: var(--bg-input); border-radius: 12px; padding: 15px; text-align: center;
            opacity: 0.4; filter: grayscale(1); transition: all 0.3s; border: 1px solid transparent;
        }
        .trophy-card.unlocked { opacity: 1; filter: grayscale(0); border-color: var(--gold); background: rgba(251, 191, 36, 0.05); }
        .trophy-icon { font-size: 2rem; margin-bottom: 8px; display: block; }

        /* --- Buttons --- */
        .btn {
            width: 100%; padding: 16px; border-radius: 14px; border: none;
            font-weight: 600; font-size: 1rem; cursor: pointer;
            display: flex; justify-content: center; align-items: center; gap: 8px;
            background: var(--primary); color: white; transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.97); }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-main); }
        .btn-ghost { background: transparent; color: var(--text-muted); border: none; font-size: 0.9rem; }
        .btn-icon { width: 32px; height: 32px; border-radius: 8px; background: var(--bg-input); color: var(--text-muted); display: flex; align-items: center; justify-content: center; border:none;}

        /* --- Timer --- */
        #active-timer {
            position: fixed; top: 15px; left: 50%; transform: translateX(-50%) translateY(-200%);
            background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(10px);
            padding: 8px 20px; border-radius: 50px; border: 1px solid var(--border);
            display: flex; gap: 10px; align-items: center; z-index: 2000;
            box-shadow: 0 8px 30px rgba(0,0,0,0.6); transition: transform 0.4s;
        }
        #active-timer.show { transform: translateX(-50%) translateY(0); }

        /* --- Nav --- */
        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; height: 85px;
            background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(20px);
            border-top: 1px solid var(--border); display: grid; grid-template-columns: repeat(4, 1fr);
            padding-bottom: 25px; z-index: 100;
        }
        .nav-btn {
            background: none; border: none; color: #52525b; font-size: 0.65rem;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px;
        }
        .nav-btn.active { color: var(--primary); }
        .nav-btn i { font-size: 1.4rem; transition: transform 0.2s; }
        .nav-btn.active i { transform: translateY(-3px); color: white; }

        /* --- Modal --- */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 3000; display: none;
            justify-content: center; align-items: flex-end; backdrop-filter: blur(4px);
        }
        .modal-sheet {
            background: #18181b; width: 100%; max-width: 600px;
            border-radius: 24px 24px 0 0; padding: 24px; border-top: 1px solid var(--border);
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .setup-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 15px; }
        .setup-item { background: var(--bg-input); border: 2px solid transparent; border-radius: 12px; padding: 15px 5px; text-align: center; cursor: pointer; }
        .setup-item.selected { border-color: var(--primary); background: rgba(99, 102, 241, 0.15); color: white; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="active-timer">
        <i class="fas fa-stopwatch" style="color:var(--primary)"></i>
        <span id="timer-text" style="font-family: monospace; font-size: 1.1rem; font-weight: 700;">00:00</span>
        <i class="fas fa-times" style="opacity:0.5; margin-left:8px;" onclick="app.timer.stop()"></i>
    </div>

    <div id="view-setup" class="view">
        <div style="text-align: center; margin-top: 60px;">
            <i class="fas fa-atom" style="font-size: 3rem; color: var(--primary); margin-bottom: 20px;"></i>
            <h1>TITAN OS</h1>
            <p class="subtitle">Omega Edition</p>
        </div>
        
        <div class="card" style="margin-top: 40px;">
            <h3>Configuraci√≥n Inicial</h3>
            <input type="text" id="setup-name" class="smart-input" placeholder="Tu Nombre" style="margin: 15px 0; text-align: left;">
            <input type="number" id="setup-weight" class="smart-input" placeholder="Peso Corporal (kg)" style="margin-bottom: 15px; text-align: left;">
            
            <h3>Selecciona tu Objetivo</h3>
            <div class="setup-grid">
                <div class="setup-item" onclick="app.setup.select('fuerza', this)">
                    <i class="fas fa-dumbbell"></i><br><span style="font-size:0.8rem">Fuerza</span>
                </div>
                <div class="setup-item" onclick="app.setup.select('hipertrofia', this)">
                    <i class="fas fa-child-reaching"></i><br><span style="font-size:0.8rem">M√∫sculo</span>
                </div>
                <div class="setup-item" onclick="app.setup.select('resistencia', this)">
                    <i class="fas fa-heart-pulse"></i><br><span style="font-size:0.8rem">Cardio</span>
                </div>
            </div>
        </div>
        <button class="btn" onclick="app.setup.finish()">INICIAR SISTEMA</button>
    </div>

    <div id="view-home" class="view">
        <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <div>
                <h2 id="user-name">Hola</h2>
                <div class="subtitle" id="user-goal">Objetivo: ...</div>
            </div>
            <div style="text-align: right;">
                <div class="subtitle">NIVEL</div>
                <h2 style="color: var(--primary);" id="user-lvl">1</h2>
            </div>
        </header>

        <div class="card" style="padding: 15px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <h3>Volumen Semanal</h3>
                <span id="week-vol" class="subtitle" style="color:var(--success)">0 kg</span>
            </div>
            <div style="height: 100px; width: 100%;">
                <canvas id="chart"></canvas>
            </div>
        </div>

        <h3 style="margin-bottom: 15px;">Plan Asignado</h3>
        <div id="routines-list"></div>

        <button class="btn btn-outline" style="border-style: dashed; opacity: 0.6; margin-top: 10px;" onclick="app.routines.create()">
            <i class="fas fa-plus"></i> Rutina Personalizada
        </button>
    </div>

    <div id="view-session" class="view">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <button class="btn-ghost" onclick="app.session.minimize()"><i class="fas fa-chevron-down fa-lg"></i></button>
            <h3 id="session-title">Entrenamiento</h3>
            <button class="btn-ghost" style="color: var(--success);" onclick="app.session.finish()"><i class="fas fa-check fa-lg"></i></button>
        </div>

        <div class="coach-box" id="global-coach-tip">
            <i class="fas fa-robot"></i>
            <span id="coach-tip-text">Analizando biomec√°nica...</span>
        </div>

        <div id="session-container"></div>

        <button class="btn btn-outline" style="margin-top: 20px;" onclick="app.session.addExercisePrompt()">
            <i class="fas fa-plus"></i> A√±adir Ejercicio
        </button>
    </div>

    <div id="view-achievements" class="view">
        <h2 style="margin-bottom: 10px;">Sala de Trofeos</h2>
        <div style="margin-bottom:20px; color:var(--text-muted); font-size:0.9rem;">Desbloquea medallas co teu esforzo.</div>
        <div class="trophy-grid" id="achievements-list"></div>
    </div>

    <div id="view-profile" class="view">
        <h2 style="margin-bottom: 20px;">Perfil</h2>
        
        <div class="card">
            <h3>Os Meus Datos</h3>
            <div style="margin: 15px 0;">
                <label style="color:#888; font-size:0.8rem;">Nome</label>
                <input type="text" id="edit-name" class="smart-input" style="text-align:left; margin-bottom:10px;">
                <label style="color:#888; font-size:0.8rem;">Peso (kg)</label>
                <input type="number" id="edit-weight" class="smart-input" style="text-align:left;">
            </div>
            <button class="btn" onclick="app.profile.update()">Gardar Cambios</button>
        </div>

        <div class="card">
            <h3>Xesti√≥n de Datos</h3>
            <button class="btn btn-outline" style="margin-top: 10px;" onclick="app.data.export()">Exportar Copia</button>
            <input type="file" id="import-file" hidden onchange="app.data.import(this)">
            <button class="btn btn-outline" style="margin-top: 10px;" onclick="document.getElementById('import-file').click()">Importar Copia</button>
            <button class="btn btn-outline" style="margin-top: 10px; border-color: var(--danger); color: var(--danger);" onclick="app.data.reset()">Reiniciar Todo</button>
        </div>
    </div>

    <div id="view-history" class="view">
        <h2 style="margin-bottom: 20px;">Historial</h2>
        <div id="history-list"></div>
    </div>

    <nav class="bottom-nav" id="main-nav">
        <button class="nav-btn active" onclick="app.nav.go('home')"><i class="fas fa-home"></i><span>Inicio</span></button>
        <button class="nav-btn" onclick="app.nav.go('history')"><i class="fas fa-clock-rotate-left"></i><span>Historial</span></button>
        <button class="nav-btn" onclick="app.nav.go('achievements')"><i class="fas fa-trophy"></i><span>Logros</span></button>
        <button class="nav-btn" onclick="app.nav.go('profile')"><i class="fas fa-user-gear"></i><span>Perfil</span></button>
    </nav>

    <div class="modal-backdrop" id="modal-plates" onclick="if(event.target===this) this.style.display='none'">
        <div class="modal-sheet">
            <h3 style="text-align:center;">Cargar Barra (20kg)</h3>
            <div id="plate-vis" style="display: flex; gap: 2px; height: 60px; align-items: center; justify-content: center; background: #000; border-radius: 8px; margin: 20px 0;"></div>
            <button class="btn" onclick="document.getElementById('modal-plates').style.display='none'">Cerrar</button>
        </div>
    </div>

    <div class="modal-backdrop" id="modal-share" onclick="if(event.target===this) this.style.display='none'">
        <div class="modal-sheet">
            <h3 style="text-align:center; margin-bottom: 10px;">Resumo do Adestramento</h3>
            <textarea id="share-text" style="width:100%; height:150px; background:#222; color:#fff; border:1px solid #444; border-radius:8px; padding:10px; font-family:monospace;" readonly></textarea>
            <button class="btn" style="margin-top:10px;" onclick="app.utils.copyShare()">Copiar Texto</button>
        </div>
    </div>

<script>
/**
 * TITAN OS - OMEGA EDITION (v15)
 * Definitive Edition.
 */

const COACHING_DB = {
    'Sentadilla': { tip: "Rodillas hacia fuera, mirada al frente.", tempo: "3-1-X" },
    'Press Banca': { tip: "Retrae esc√°pulas, codos a 45¬∫.", tempo: "2-1-1" },
    'Peso Muerto': { tip: "Barra pegada a las tibias, espalda neutra.", tempo: "X-1-3" },
    'Press Militar': { tip: "Aprieta gl√∫teos y abdomen.", tempo: "2-0-1" },
    'Dominadas': { tip: "Inicia bajando los hombros.", tempo: "2-1-1" },
    'Remo': { tip: "Barra a la cadera, no al pecho.", tempo: "2-1-1" },
    'B√≠ceps': { tip: "Codos pegados al cuerpo.", tempo: "3-0-1" },
    'Tr√≠ceps': { tip: "Bloquea el codo al final.", tempo: "2-0-1" },
    'Prensa': { tip: "No bloquees rodillas al subir.", tempo: "3-0-1" },
    'Elevaciones': { tip: "Codos lideran el movimiento.", tempo: "2-1-2" }
};

const TEMPLATES = {
    fuerza: [
        { id: 'str_a', name: 'Torso Fuerza', exercises: ['Press Banca', 'Remo con Barra', 'Press Militar', 'Dominadas'] },
        { id: 'str_b', name: 'Pierna Fuerza', exercises: ['Sentadilla', 'Peso Muerto', 'Prensa', 'Plancha'] }
    ],
    hipertrofia: [
        { id: 'hyp_push', name: 'Push (Empuje)', exercises: ['Press Banca', 'Press Inclinado', 'Elevaciones Laterales', 'Extensi√≥n Tr√≠ceps'] },
        { id: 'hyp_pull', name: 'Pull (Tracci√≥n)', exercises: ['Dominadas', 'Remo Polea', 'Face Pull', 'Curl B√≠ceps'] },
        { id: 'hyp_legs', name: 'Legs (Pierna)', exercises: ['Sentadilla Hack', 'Peso Muerto Rumano', 'Extensiones', 'Gemelos'] }
    ],
    resistencia: [
        { id: 'end_a', name: 'Full Body Circuito A', exercises: ['Goblet Squat', 'Flexiones', 'Remo TRX', 'Burpees'] },
        { id: 'end_b', name: 'Full Body Circuito B', exercises: ['Zancadas', 'Press Militar', 'Jal√≥n al Pecho', 'Mountain Climbers'] }
    ]
};

const SUBSTITUTES = {
    'Press Banca': ['Press Mancuernas', 'Press M√°quina', 'Fondos'],
    'Sentadilla': ['Prensa', 'Sentadilla Hack', 'Zancadas'],
    'Peso Muerto': ['Peso Muerto Rumano', 'Hip Thrust', 'Rack Pull'],
    'Press Militar': ['Press Arnold', 'Elevaciones Laterales', 'Press M√°quina'],
    'Dominadas': ['Jal√≥n al Pecho', 'Remo M√°quina'],
    'Remo con Barra': ['Remo Polea', 'Remo Mancuerna'],
    'Curl B√≠ceps': ['Curl Martillo', 'Dominadas Supinas'],
    'Extensi√≥n Tr√≠ceps': ['Press Franc√©s', 'Fondos']
};

const ACHIEVEMENTS = [
    { id: 'first_blood', icon: 'ü©∏', title: 'Primera Sangre', desc: 'Completa tu primer entrenamiento', cond: (u,h) => h.length >= 1 },
    { id: 'consistency', icon: 'üî•', title: 'En Llamas', desc: 'Completa 5 entrenamientos', cond: (u,h) => h.length >= 5 },
    { id: 'veteran', icon: 'üéñÔ∏è', title: 'Veterano', desc: 'Completa 20 entrenamientos', cond: (u,h) => h.length >= 20 },
    { id: 'heavy_lifter', icon: 'ü¶ç', title: 'Bestia', desc: 'Mueve 10.000kg de volumen total', cond: (u,h) => u.totalVolume >= 10000 },
    { id: 'level_5', icon: '‚≠ê', title: 'Nivel 5', desc: 'Alcanza el nivel 5 de experiencia', cond: (u,h) => u.level >= 5 }
];

const app = {
    data: { user: {}, routines: [], history: [], activeSession: null, unlocked: [] },

    init() {
        const stored = localStorage.getItem('titan_omega_v15');
        if (stored) {
            try {
                this.data = JSON.parse(stored);
                if(!this.data.history) this.data.history = [];
                if(!this.data.routines) this.data.routines = [];
                if(!this.data.unlocked) this.data.unlocked = [];
                if(this.data.user.totalVolume === undefined) this.data.user.totalVolume = 0;
                
                this.nav.go('home');
                this.home.render();
            } catch (e) { this.data.reset(); }
        } else {
            this.nav.go('setup');
        }
    },
    save() { localStorage.setItem('titan_omega_v15', JSON.stringify(this.data)); },

    // --- SETUP ---
    setup: {
        choice: null,
        select(c, el) {
            this.choice = c;
            document.querySelectorAll('.setup-item').forEach(i => i.classList.remove('selected'));
            el.classList.add('selected');
        },
        finish() {
            const name = document.getElementById('setup-name').value || 'Atleta';
            const weight = document.getElementById('setup-weight').value || 70;
            if (!this.choice) return alert("Selecciona un objetivo.");
            
            app.data.user = { name, weight, goal: this.choice, level: 1, xp: 0, totalVolume: 0 };
            app.data.routines = JSON.parse(JSON.stringify(TEMPLATES[this.choice]));
            app.save();
            app.nav.go('home');
            app.home.render();
        }
    },

    // --- HOME ---
    home: {
        render() {
            const u = app.data.user;
            document.getElementById('user-name').innerText = `Hola, ${u.name}`;
            document.getElementById('user-goal').innerText = `Enfoque: ${u.goal.toUpperCase()}`;
            document.getElementById('user-lvl').innerText = u.level;

            const list = document.getElementById('routines-list');
            list.innerHTML = '';
            app.data.routines.forEach(r => {
                const el = document.createElement('div');
                el.className = 'card';
                el.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div><h3>${r.name}</h3><div class="subtitle">${r.exercises.length} Ejercicios</div></div>
                        <button class="btn" style="width:50px; padding:0;" onclick="app.session.start('${r.id}')"><i class="fas fa-play"></i></button>
                    </div>`;
                list.appendChild(el);
            });
            this.renderChart();
        },
        renderChart() {
            const ctx = document.getElementById('chart');
            const h = app.data.history || [];
            const last7 = h.slice(-7);
            const data = last7.length ? last7.map(x => x.vol) : [0,0,0,0];
            const labels = last7.length ? last7.map((_,i) => i+1) : ['','','',''];
            document.getElementById('week-vol').innerText = (data.reduce((a,b)=>a+b,0)) + " kg";

            if(window.chartInstance) window.chartInstance.destroy();
            window.chartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets: [{ data, borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', fill: true, tension: 0.4 }] },
                options: { plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } }, maintainAspectRatio: false }
            });
        }
    },

    // --- SESSION ---
    session: {
        start(rid) {
            const r = app.data.routines.find(x => x.id === rid);
            if (!r) return;

            const s = {
                name: r.name,
                startTime: Date.now(),
                exercises: r.exercises.map(name => {
                    const lastLog = app.utils.getLastLog(name);
                    let suggestion = null;
                    let ghostWeight = '';

                    if (lastLog) {
                        const maxW = Math.max(...lastLog.sets.map(s => parseFloat(s.w) || 0));
                        if (maxW > 0) {
                            suggestion = maxW + 2.5; 
                            ghostWeight = maxW;
                        }
                    }

                    const sets = [];
                    for(let i=0; i<3; i++) {
                        sets.push({ w: '', r: '', rpe: '', ghost: ghostWeight, done: false });
                    }
                    return { name, suggestion, sets };
                })
            };
            app.data.activeSession = s;
            app.nav.go('session');
            document.getElementById('main-nav').classList.add('hidden');
            
            const tips = ["Controla la exc√©ntrica.", "Hidr√°tate bien.", "T√©cnica > Peso.", "Descansa 90s en compuestos."];
            document.getElementById('coach-tip-text').innerText = tips[Math.floor(Math.random()*tips.length)];
            
            this.render();
        },

        render() {
            const s = app.data.activeSession;
            document.getElementById('session-title').innerText = s.name;
            const c = document.getElementById('session-container');
            c.innerHTML = '';

            s.exercises.forEach((ex, exIdx) => {
                let badge = ex.suggestion ? `<div class="badge-suggestion">üèÜ Meta: ${ex.suggestion}kg</div>` : '';
                
                let coachData = { tip: "", tempo: "" };
                for(const key in COACHING_DB) {
                    if(ex.name.includes(key)) coachData = COACHING_DB[key];
                }
                let tipHtml = coachData.tip ? `<div class="subtitle" style="color:var(--primary); font-size:0.75rem; margin-bottom:5px;"><i class="fas fa-lightbulb"></i> ${coachData.tip}</div>` : '';

                let rows = '';
                ex.sets.forEach((set, setIdx) => {
                    const w = parseFloat(set.w) || parseFloat(set.ghost) || 0;
                    const r = parseFloat(set.r) || 0;
                    const rm = (w && r) ? Math.round(w * (1 + r/30)) : 0;
                    const rmBadge = rm > 0 ? `<div class="badge-1rm">1RM: ${rm}</div>` : '';

                    rows += `
                    <div class="input-row">
                        <span style="color:#444; font-size:0.8rem; text-align:center;">${setIdx+1}</span>
                        <div class="input-wrapper">
                            ${rmBadge}
                            <input type="number" class="smart-input" placeholder="${set.ghost || '-'}" value="${set.w}"
                                oninput="app.session.update(${exIdx}, ${setIdx}, 'w', this.value); app.session.render1RM(this)">
                            <i class="fas fa-compact-disc input-tool-icon" onclick="app.tools.showPlates(${set.w || set.ghost || 0})"></i>
                        </div>
                        <div class="input-wrapper">
                             <input type="number" class="smart-input" placeholder="Reps" value="${set.r}"
                             oninput="app.session.update(${exIdx}, ${setIdx}, 'r', this.value); app.session.render1RM(this)">
                        </div>
                        <div class="input-wrapper">
                            <input type="number" class="rpe-input" placeholder="RPE" value="${set.rpe}" 
                            oninput="app.session.update(${exIdx}, ${setIdx}, 'rpe', this.value)">
                        </div>
                        <div class="checkbox ${set.done ? 'checked' : ''}" onclick="app.session.toggle(${exIdx}, ${setIdx})">
                            <i class="fas fa-check"></i>
                        </div>
                    </div>`;
                });

                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <div>
                            <h3>${ex.name} ${coachData.tempo ? `<span style="font-size:0.65rem; color:var(--purple); border:1px solid var(--purple); padding:2px 4px; border-radius:4px;">${coachData.tempo}</span>` : ''}</h3>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <button class="btn-icon" onclick="app.session.swap(${exIdx})"><i class="fas fa-rotate"></i></button>
                            <button class="btn-ghost" onclick="app.session.addSet(${exIdx})">+ Set</button>
                        </div>
                    </div>
                    ${tipHtml}
                    ${badge}
                    <div style="display:grid; grid-template-columns: 24px 1.2fr 1fr 0.6fr 44px; gap:8px; margin:10px 0 5px 0; font-size:0.65rem; color:#666; text-align:center;">
                        <span>#</span><span>KG</span><span>REPS</span><span>RPE</span><span>OK</span>
                    </div>
                    ${rows}`;
                c.appendChild(div);
            });
        },

        render1RM(inputEl) { /* Trigger refresh if needed */ },

        update(ei, si, k, v) { app.data.activeSession.exercises[ei].sets[si][k] = v; },
        
        toggle(ei, si) {
            const set = app.data.activeSession.exercises[ei].sets[si];
            set.done = !set.done;
            this.render();
            if (set.done) {
                if (navigator.vibrate) navigator.vibrate(50);
                app.timer.start(90);
            }
        },

        addSet(ei) {
            const ex = app.data.activeSession.exercises[ei];
            const last = ex.sets[ex.sets.length-1];
            ex.sets.push({ w: '', r: '', rpe: '', ghost: last?.ghost||'', done: false });
            this.render();
        },

        swap(ei) {
            const current = app.data.activeSession.exercises[ei].name;
            const alts = SUBSTITUTES[current];
            if (!alts) return alert("No hay variantes predefinidas. Usa 'A√±adir Ejercicio'.");
            const choice = prompt(`Cambiar ${current} por:\n` + alts.join('\n- '));
            if (choice) {
                app.data.activeSession.exercises[ei].name = choice;
                app.data.activeSession.exercises[ei].suggestion = null; 
                this.render();
            }
        },

        addExercisePrompt() {
            const n = prompt("Nombre:");
            if (n) {
                app.data.activeSession.exercises.push({ name: n, suggestion: null, sets: [{w:'',r:'',done:false},{w:'',r:'',done:false},{w:'',r:'',done:false}] });
                this.render();
            }
        },

        finish() {
            if (!confirm("¬øFinalizar?")) return;
            const s = app.data.activeSession;
            let vol = 0;
            
            const cleanEx = s.exercises.map(ex => {
                const valid = ex.sets.filter(x => x.done);
                valid.forEach(x => {
                    const w = parseFloat(x.w) || parseFloat(x.ghost) || 0;
                    const r = parseFloat(x.r) || 0;
                    vol += w * r;
                    x.w = w; 
                });
                return { name: ex.name, sets: valid };
            }).filter(e => e.sets.length > 0);

            if (cleanEx.length > 0) {
                app.data.history.push({ date: Date.now(), routine: s.name, vol, exercises: cleanEx });
                app.data.user.xp += (vol / 100);
                app.data.user.totalVolume += vol;
                app.data.user.level = Math.floor(Math.sqrt(app.data.user.xp / 50)) + 1;
                app.achievements.check();
                app.save();
                confetti();
                
                // Show Share Modal
                app.utils.showShare(s.name, vol, cleanEx.length);
            }

            app.data.activeSession = null;
            app.nav.go('home');
            document.getElementById('main-nav').classList.remove('hidden');
            app.home.render();
        },

        minimize() {
            if (confirm("¬øSalir sin guardar?")) {
                app.data.activeSession = null;
                app.nav.go('home');
                document.getElementById('main-nav').classList.remove('hidden');
            }
        }
    },

    // --- ACHIEVEMENTS ---
    achievements: {
        check() {
            const u = app.data.user;
            const h = app.data.history;
            ACHIEVEMENTS.forEach(a => {
                if (!app.data.unlocked.includes(a.id)) {
                    if (a.cond(u, h)) {
                        app.data.unlocked.push(a.id);
                        alert(`üèÜ LOGRO DESBLOQUEADO: ${a.title}`);
                    }
                }
            });
        },
        render() {
            const grid = document.getElementById('achievements-list');
            grid.innerHTML = '';
            ACHIEVEMENTS.forEach(a => {
                const unlocked = app.data.unlocked.includes(a.id);
                const div = document.createElement('div');
                div.className = `trophy-card ${unlocked ? 'unlocked' : ''}`;
                div.innerHTML = `<span class="trophy-icon">${a.icon}</span><div style="font-weight:700; font-size:0.9rem;">${a.title}</div><div class="subtitle">${a.desc}</div>`;
                grid.appendChild(div);
            });
        }
    },

    // --- PROFILE ---
    profile: {
        render() {
            document.getElementById('edit-name').value = app.data.user.name;
            document.getElementById('edit-weight').value = app.data.user.weight;
        },
        update() {
            app.data.user.name = document.getElementById('edit-name').value;
            app.data.user.weight = document.getElementById('edit-weight').value;
            app.save();
            alert("Perfil Actualizado");
        }
    },

    // --- TOOLS ---
    timer: {
        int: null,
        start(sec) {
            clearInterval(this.int);
            let s = sec;
            document.getElementById('active-timer').classList.add('show');
            const tick = () => {
                const m = Math.floor(s/60).toString().padStart(2,'0');
                const ss = (s%60).toString().padStart(2,'0');
                document.getElementById('timer-text').innerText = `${m}:${ss}`;
                if (s <= 0) this.stop();
                s--;
            };
            tick();
            this.int = setInterval(tick, 1000);
        },
        stop() { clearInterval(this.int); document.getElementById('active-timer').classList.remove('show'); }
    },

    tools: {
        showPlates(w) {
            const d = document.getElementById('plate-vis');
            d.innerHTML = '';
            let val = (w - 20) / 2;
            if (val <= 0) { d.innerHTML = '<span style="color:#666">Barra Vac√≠a</span>'; }
            else {
                [20,15,10,5,2.5,1.25].forEach(p => {
                    const colors = {20:'#ef4444',15:'#3b82f6',10:'#10b981',5:'#fff',2.5:'#6b7280',1.25:'#a1a1aa'};
                    while(val >= p) {
                        const el = document.createElement('div');
                        el.style.cssText = `height:${40+p*1.5}px;width:${8+p/2}px;background:${colors[p]};border-radius:2px;`;
                        d.appendChild(el); val -= p;
                    }
                });
            }
            document.getElementById('modal-plates').style.display = 'flex';
        }
    },

    // --- UTILS ---
    utils: {
        getLastLog(name) {
            if (!app.data.history) return null;
            for(let i=app.data.history.length-1; i>=0; i--) {
                const ex = app.data.history[i].exercises.find(e => e.name === name);
                if (ex) return ex;
            }
            return null;
        },
        showShare(name, vol, exs) {
            const modal = document.getElementById('modal-share');
            const txt = document.getElementById('share-text');
            txt.value = `üöÄ TITAN OS WORKOUT\n\nüìå Rutina: ${name}\nüèãÔ∏è Volumen: ${vol}kg\n‚ö° Ejercicios: ${exs}\n\nConquistado con Titan OS.`;
            modal.style.display = 'flex';
        },
        copyShare() {
            const t = document.getElementById('share-text');
            t.select();
            document.execCommand('copy');
            alert("Copiado!");
            document.getElementById('modal-share').style.display = 'none';
        }
    },

    routines: {
        create() {
            const n = prompt("Nombre de Rutina:");
            if (n) {
                app.data.routines.push({ id: 'custom_'+Date.now(), name: n, exercises: [] });
                app.save();
                app.home.render();
            }
        }
    },

    nav: {
        go(id) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById('view-'+id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            if(id === 'home') document.querySelectorAll('.nav-btn')[0].classList.add('active');
            if(id === 'history') {
                document.querySelectorAll('.nav-btn')[1].classList.add('active');
                app.history.render();
            }
            if(id === 'achievements') {
                document.querySelectorAll('.nav-btn')[2].classList.add('active');
                app.achievements.render();
            }
            if(id === 'profile') {
                document.querySelectorAll('.nav-btn')[3].classList.add('active');
                app.profile.render();
            }
        }
    },

    history: {
        render() {
            const l = document.getElementById('history-list');
            l.innerHTML = '';
            const h = [...(app.data.history || [])].reverse();
            if (h.length === 0) l.innerHTML = '<div style="text-align:center; color:#666">Sin datos</div>';
            h.forEach(s => {
                const el = document.createElement('div');
                el.className = 'card';
                el.innerHTML = `<div style="display:flex; justify-content:space-between;"><div><strong>${s.routine}</strong><div class="subtitle">${new Date(s.date).toLocaleDateString()}</div></div><div><strong>${(s.vol/1000).toFixed(1)}k</strong></div></div>`;
                l.appendChild(el);
            });
        }
    },

    data: {
        export() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(app.data));
            const a = document.createElement('a'); a.href = dataStr; a.download = "titan_omega_backup.json"; a.click();
        },
        import(input) {
            const fr = new FileReader();
            fr.onload = e => { app.data = JSON.parse(e.target.result); app.save(); location.reload(); };
            fr.readAsText(input.files[0]);
        },
        reset() { if(confirm("¬øBorrar todo?")) { localStorage.clear(); location.reload(); } }
    }
};

window.onload = () => app.init();
</script>
</body>
</html>